{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@shebaoting/repost/webpack/bootstrap","webpack://@shebaoting/repost/webpack/runtime/compat get default export","webpack://@shebaoting/repost/webpack/runtime/define property getters","webpack://@shebaoting/repost/webpack/runtime/hasOwnProperty shorthand","webpack://@shebaoting/repost/external root \"flarum.core.compat['common/app']\"","webpack://@shebaoting/repost/./src/common/index.ts","webpack://@shebaoting/repost/external root \"flarum.core.compat['forum/app']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['common/extend']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['forum/components/DiscussionComposer']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['forum/components/EditPostComposer']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['models/Discussion']\"","webpack://@shebaoting/repost/external root \"flarum.core.compat['common/Model']\"","webpack://@shebaoting/repost/./src/forum/index.ts","webpack://@shebaoting/repost/./src/forum/components/OriginalUrlInput.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/app'];","import app from 'flarum/common/app';\n\napp.initializers.add('shebaoting/repost', () => {\n  console.log('[shebaoting/repost] Hello, forum and admin!');\n});\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/EditPostComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['models/Discussion'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/Model'];","import app from 'flarum/forum/app';\nimport addOriginalUrlInput from './components/OriginalUrlInput';\n\napp.initializers.add('shebaoting-repost', () => {\n  console.log('[shebaoting/repost] Hello, forum!');\n  addOriginalUrlInput();\n});\n","import { extend } from 'flarum/common/extend';\nimport DiscussionComposer from 'flarum/forum/components/DiscussionComposer';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport EditPostComposer from 'flarum/forum/components/EditPostComposer';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport Discussion from 'flarum/models/Discussion';\nimport Model from 'flarum/common/Model';\n\nexport default function () {\n  function handleOriginalUrl(data) {\n    // 获取帖子内容\n    const content = data.content;\n\n    // 检查内容是否以 http:// 或 https:// 开头\n    const urlPattern = /^(https?:\\/\\/[^\\s]+)/;\n    const match = content.match(urlPattern);\n    console.log('Matched URL:', match);\n    data.attributes = data.attributes || {};\n\n    if (match) {\n      // 提取匹配的 URL 并更新 original_url\n      const originalUrl = match[0];\n      data.attributes.originalUrl = originalUrl;\n      console.log('Original URL set:', originalUrl);\n    } else {\n      // 如果内容开头不是网址，重置 original_url 为空\n      data.attributes.originalUrl = '';\n      console.log('Original URL cleared');\n    }\n  }\n\n  // 扩展新帖子的创建逻辑\n  extend(DiscussionComposer.prototype, 'data', function (data) {\n    handleOriginalUrl(data);\n  });\n\n  // 扩展帖子编辑的逻辑\n  extend(EditPostComposer.prototype, 'data', function (data) {\n    handleOriginalUrl(data);\n  });\n\n  extend(DiscussionListItem.prototype, 'infoItems', function (items) {\n    const originalUrl = this.attrs.discussion.attribute('original_url');\n    if (originalUrl) {\n      try {\n        const url = new URL(originalUrl);\n        const domain = url.hostname; // 获取域名信息，比如 chat.chatgpt.com\n\n        items.add(\n          'originalUrl',\n          m(\n            'span',\n            {\n              className: 'item-terminalPost',\n            },\n            domain\n          ), // 仅显示域名部分\n          -10\n        );\n      } catch (e) {\n        console.error('Invalid URL:', originalUrl);\n      }\n    }\n  });\n\n  // 修改帖子标题的点击行为\n  extend(DiscussionListItem.prototype, 'view', function (vnode) {\n    const originalUrl = this.attrs.discussion.attribute('original_url');\n\n    if (originalUrl) {\n      // 递归查找标题元素的函数\n      const findTitleElement = (children) => {\n        if (!children) return null;\n        for (let child of children) {\n          // 确保 child 存在且具有 tag 属性\n          if (child && child.tag && child.attrs && child.attrs.className === 'DiscussionListItem-title') {\n            return child;\n          }\n          if (child && child.children) {\n            const found = findTitleElement(child.children);\n            if (found) return found;\n          }\n        }\n        return null;\n      };\n\n      // 查找标题元素\n      const titleElement = findTitleElement(vnode.children);\n      if (titleElement) {\n        // 为标题添加点击事件\n        titleElement.attrs.onclick = function (event) {\n          event.preventDefault(); // 阻止默认的 a 标签跳转行为\n          event.stopPropagation(); // 阻止事件传播\n\n          window.open(originalUrl, '_blank', 'noopener'); // 打开 original_url\n\n          return false; // 确保阻止默认行为\n        };\n      }\n    }\n\n    return vnode;\n  });\n\n  Discussion.prototype.originalUrl = Model.attribute('original_url');\n\n  extend(DiscussionPage.prototype, 'onupdate', function () {\n    const discussion = this.discussion;\n\n    // 确保讨论已经加载并且有 originalUrl\n    if (discussion && discussion.originalUrl()) {\n      const originalUrl = discussion.originalUrl();\n\n      if (originalUrl) {\n        const noticeElement = document.createElement('div');\n        noticeElement.className = 'OriginalUrlNotice';\n        noticeElement.innerHTML = `\n          <p>${app.translator.trans('shebaoting-repost.forum.notice_message')}</p>\n        `;\n\n        // 找到第一个帖子元素\n        const firstPost = this.$('.PostStream-item:first-child .Post-body')[0];\n\n        // 检查是否已经插入提示，避免重复插入\n        if (firstPost && !this.$('.OriginalUrlNotice').length) {\n          firstPost.parentNode.insertBefore(noticeElement, firstPost.nextSibling);\n        }\n      }\n    }\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","app","add","console","log","handleOriginalUrl","data","match","content","attributes","originalUrl","extend","DiscussionComposer","EditPostComposer","DiscussionListItem","items","this","attrs","discussion","attribute","domain","URL","hostname","m","className","e","error","vnode","findTitleElement","children","_step","_iterator","_createForOfIteratorHelperLoose","done","child","value","tag","found","titleElement","onclick","event","preventDefault","stopPropagation","window","open","Discussion","Model","DiscussionPage","noticeElement","document","createElement","innerHTML","translator","trans","firstPost","$","length","parentNode","insertBefore","nextSibling","addOriginalUrlInput"],"sourceRoot":""}